{% extends 'base.html'%}
{% block content %}

    <a href="/logout" style="float:right">Log Out</a>
    {% if matches|length %}
    <h2>{{name}}'s Buddie/s:</h2>
    {% for user in matches %}
 
        <h4>{{ matches[user][0] }} <button class='user-id' target='{{ matches[user][2] }}' name="{{ matches[user][4] }}"><img src="http://www.myiconfinder.com/uploads/iconsets/256-256-f269bbc2a3bd8805b0dccb6c36dd2fac.png" width="16" height="16"></button></h4> 

        {% if matches[user][1] %}
            <i>Interests: {{ matches[user][0] }}</i>
            <br>
        {% endif %}

        </form>
        Restaurant: {{ matches[user][3]['rest_title'] }}
        <br>
        Rating: {{ matches[user][3]['rating'] }}
        <br>
        Number of Reviews: {{ matches[user][3]['num_reviews'] }}
        <br>
        Address: {{ matches[user][3]['address'] }}
        <br>
        Phone: <a href="tel:{{ matches[user][3]['phone'] }}">{{ matches[user][3]['phone'] }}</a> 
        
        <br><br>

    {% endfor %}
        <div id="notif"></div>
        <h2>Messages</h2>
        <div id="log"></div>

        <form id="send_room" class="mess" method="POST" action='#'>

            <input type="text" name="room_data" id="room_data" placeholder="Message">
            <input type="submit" value="Send">
        </form>

        <form id="leave" method="POST" action='#'>
              <input type="submit" value="Close">
        </form>

    {% else %}
        <h3>I didn't find a buddy today.</h3>
    {% endif %}

    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.5/socket.io.min.js"></script>
    <script type="text/javascript" charset="utf-8">
        $(document).ready(function() {
          // namespace are set to a route string since multiple channels are needed
            namespace='/munchbuddies';

            // connect to the SOCKET.IO server.
            // URL format
            let socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port + namespace);

            // socket.on use to define event handler

            // event handler for server sent data
            // Callback function is invoked whenever the server emits data to the client. 
            // data will be displayed in the Receive section of the page

              //Handlers for the different forms in the page
             // Accepts data from the user and send it to the server in a different ways 
            // $( window ).load(function(){
            //     socket.emit('join', {room: $('#curr_user').attr('content')});
            // });
            $('.user-id').click(function(event){
                let rm = $(this).attr('target')
                let name_id = $(this).attr('name')
                socket.emit('join', {room: rm});
                
                '{% for message in all_messages %}'
                    '{% for room in message %}'
                        if ('{{ room }}' == rm){
                            '{% for chat in message[room] %}'
                               $('#log').append('<p><small><small><i> {{chat["date"]}}</i></small></small> <br>{{chat["from"]}}: {{chat["message"]}}</p>');
                            '{% endfor %}'
                    };
                    '{% endfor %}'  
                '{% endfor %}'
                
                $('form.mess').submit(function(event) {
                    socket.emit('my_room_event', {sender: '{{ name }}', 
                                                  receiver_id: name_id,
                                                  room: rm, 
                                                  data: $('#room_data').val()});
                    $('#room_data').val('');
                    return false;
                });

                $('form#leave').submit(function(event) {
                    socket.emit('disconnect_request');
                    setInterval(function(){
                        window.location.reload(true);
                    }, 1000);

                    return false;
                });

                // $('form#leave').submit(function(event) {
                //     socket.emit('leave', {room: rm});
                //     return false;
                // });
            });
            
            socket.on('my_response', function(msg) {
                    $('#log').append('<p>' + msg.sender + ': ' + msg.data + '</p>');
            });
       });
    </script>

{% endblock %}
